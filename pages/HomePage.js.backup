// Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

import Header from '../components/ui/Header.js';
import Footer from '../components/ui/Footer.js';
import HeroSection from '../components/layout/HeroSection.js';
import ServicesSection from '../components/layout/ServicesSection.js';
import StatisticsSection from '../components/layout/StatisticsSection.js';
import GallerySection from '../components/layout/GallerySection.js';
import ClientsSection from '../components/layout/ClientsSection.js';
import ContactSection from '../components/layout/ContactSection.js';
import TopBar from '../components/ui/TopBar.js';
import AnnouncementBar from '../components/ui/AnnouncementBar.js';

class HomePage {
    constructor(eventBus, stateManager) {
        this.eventBus = eventBus;
        this.stateManager = stateManager;
        
        // Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        this.components = {
            topBar: null,
            announcementBar: null,
            header: null,
            hero: null,
            services: null,
            statistics: null,
            gallery: null,
            clients: null,
            contact: null,
            footer: null
        };
        
        // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
        this.unsubscribe = this.stateManager.subscribe(
            this.onStateChange.bind(this),
            ['ui.theme', 'ui.language', 'data.services']
        );
    }
    
    // Ø§Ù„ØªØµÙŠÙŠØ±
    render() {
        return `
            <div class="page home-page">
                ${this.components.topBar ? this.components.topBar.render() : ''}
                ${this.components.announcementBar ? this.components.announcementBar.render() : ''}
                ${this.components.header ? this.components.header.render() : ''}
                
                <main class="page-content">
                    ${this.components.hero ? this.components.hero.render() : ''}
                    ${this.components.services ? this.components.services.render() : ''}
                    ${this.components.statistics ? this.components.statistics.render() : ''}
                    ${this.components.gallery ? this.components.gallery.render() : ''}
                    ${this.components.clients ? this.components.clients.render() : ''}
                    ${this.components.contact ? this.components.contact.render() : ''}
                </main>
                
                ${this.components.footer ? this.components.footer.render() : ''}
            </div>
        `;
    }
    
    // Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    async init() {
        console.log('ğŸ  ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...');
        
        try {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
            this.components.topBar = new TopBar(this.eventBus, this.stateManager);
            this.components.announcementBar = new AnnouncementBar(this.eventBus, this.stateManager);
            this.components.header = new Header(this.eventBus, this.stateManager);
            this.components.hero = new HeroSection(this.eventBus, this.stateManager);
            this.components.services = new ServicesSection(this.eventBus, this.stateManager);
            this.components.statistics = new StatisticsSection(this.eventBus, this.stateManager);
            this.components.gallery = new GallerySection(this.eventBus, this.stateManager);
            this.components.clients = new ClientsSection(this.eventBus, this.stateManager);
            this.components.contact = new ContactSection(this.eventBus, this.stateManager);
            this.components.footer = new Footer(this.eventBus, this.stateManager);
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
            await Promise.all([
                this.components.topBar.init(),
                this.components.announcementBar.init(),
                this.components.header.init(),
                this.components.hero.init(),
                this.components.services.init(),
                this.components.statistics.init(),
                this.components.gallery.init(),
                this.components.clients.init(),
                this.components.contact.init(),
                this.components.footer.init()
            ]);
            
            // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            this.bindEvents();
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
            document.title = 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ù…Ø§Ø±ÙˆÙ† Ù‡Ø§Ø¨';
            
            // Ø¥Ø·Ù„Ø§Ù‚ event ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            this.eventBus.emit('page:loaded', {
                name: 'home',
                timestamp: new Date().toISOString()
            });
            
            console.log('âœ… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ù‡ÙŠØ£Ø© Ø¨Ù†Ø¬Ø§Ø­');
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:', error);
            throw error;
        }
    }
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
    onStateChange(newState, oldState, changedPaths) {
        console.log('ğŸ”„ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:', changedPaths);
        
        // Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø®Ø¯Ù…Ø§ØªØŒ ØªØ­Ø¯ÙŠØ« Ù…ÙƒÙˆÙ† Ø§Ù„Ø®Ø¯Ù…Ø§Øª
        if (changedPaths.includes('data.services') && this.components.services) {
            this.components.services.updateServices(newState.data.services);
        }
        
        // Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø³Ù…Ø©ØŒ ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        if (changedPaths.includes('ui.theme')) {
            this.updateTheme(newState.ui.theme);
        }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù…Ø©
    updateTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        
        // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        Object.values(this.components).forEach(component => {
            if (component && component.updateTheme) {
                component.updateTheme(theme);
            }
        });
    }
    
    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    bindEvents() {
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙ…Ø±ÙŠØ±
        window.addEventListener('scroll', this.handleScroll.bind(this));
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù‚Ø±
        document.addEventListener('click', this.handleClick.bind(this));
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        this.eventBus.on('button:click', this.handleButtonClick.bind(this));
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
        this.eventBus.on('form:submit', this.handleFormSubmit.bind(this));
    }
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
    handleScroll() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰
        const backToTop = document.querySelector('.back-to-top');
        if (backToTop) {
            if (scrollTop > 300) {
                backToTop.classList.add('visible');
            } else {
                backToTop.classList.remove('visible');
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        this.stateManager.setState({
            ui: {
                ...this.stateManager.state.ui,
                scrollPosition: scrollTop
            }
        });
    }
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø±
    handleClick(event) {
        const target = event.target;
        
        // Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰
        if (target.closest('.back-to-top')) {
            event.preventDefault();
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø¯Ø§Ø®Ù„ÙŠ
        if (target.closest('a[href^="#"]')) {
            event.preventDefault();
            const href = target.getAttribute('href');
            const targetElement = document.querySelector(href);
            
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }
    }
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù†Ù‚Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    handleButtonClick(data) {
        console.log('ğŸ”˜ Ø²Ø± ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡:', data);
        
        switch (data.action) {
            case 'quote':
                this.openQuoteModal();
                break;
            
            case 'contact':
                this.openContactModal();
                break;
            
            case 'whatsapp':
                this.openWhatsApp();
                break;
            
            case 'service':
                this.openServiceDetails(data.serviceId);
                break;
        }
    }
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    handleFormSubmit(data) {
        console.log('ğŸ“ Ù†Ù…ÙˆØ°Ø¬ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡:', data);
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        this.showMessage('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
    
    // ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±
    openQuoteModal() {
        this.stateManager.actions.openModal('quote');
    }
    
    // ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§ØªØµØ§Ù„
    openContactModal() {
        this.stateManager.actions.openModal('contact');
    }
    
    // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨
    openWhatsApp() {
        const config = this.stateManager.getState('config');
        const phone = config.company.whatsapp || config.company.phone;
        const message = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ÙŠØ¯ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø­ÙˆÙ„ Ø®Ø¯Ù…Ø§ØªÙƒÙ…';
        
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
    }
    
    // ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
    openServiceDetails(serviceId) {
        // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø®Ø¯Ù…Ø©
        this.eventBus.emit('navigate:to', {
            path: `/services/${serviceId}`
        });
    }
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
    showMessage(text, type = 'info') {
        this.stateManager.actions.addNotification({
            type,
            text,
            persistent: false
        });
    }
    
    // ØªØ¯Ù…ÙŠØ± Ø§Ù„ØµÙØ­Ø©
    destroy() {
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
        if (this.unsubscribe) {
            this.unsubscribe();
        }
        
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        window.removeEventListener('scroll', this.handleScroll);
        document.removeEventListener('click', this.handleClick);
        
        // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        Object.values(this.components).forEach(component => {
            if (component && component.destroy) {
                component.destroy();
            }
        });
        
        console.log('ğŸ—‘ï¸ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¯Ù…Ø±Øª');
    }
}

export default HomePage;
